name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Release Assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if npm ci 2>/dev/null; then
            echo "âœ… npm ci succeeded"
          else
            echo "âš ï¸ npm ci failed, falling back to npm install"
            npm install
          fi

      - name: Run tests
        run: npm test

      - name: Build release version
        run: npm run build:minify

      - name: Build non-minified version (for debugging)
        run: npm run build -- --output=dist/worker.debug.js

      - name: Verify build outputs
        run: |
          echo "âœ… æ£€æŸ¥æž„å»ºè¾“å‡º..."
          ls -lh dist/
          echo ""
          echo "ðŸ“¦ æ–‡ä»¶ä¿¡æ¯ï¼š"
          du -h dist/worker.js
          du -h dist/worker.debug.js
          echo ""
          echo "ðŸ“„ å…ƒæ•°æ®ï¼š"
          cat dist/worker.metadata.json

      - name: Generate checksums
        run: |
          cd dist
          sha256sum worker.js > worker.js.sha256
          sha256sum worker.debug.js > worker.debug.js.sha256
          sha256sum worker.metadata.json > worker.metadata.json.sha256
          echo "âœ… Checksums å·²ç”Ÿæˆï¼š"
          cat *.sha256

      - name: Create release archive
        run: |
          cd dist
          zip -r ../2fa-release.zip .
          cd ..
          echo "âœ… Release åŽ‹ç¼©åŒ…å·²åˆ›å»º"
          ls -lh 2fa-release.zip

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            dist/worker.js
            dist/worker.debug.js
            dist/worker.metadata.json
            dist/DEPLOY.md
            dist/*.sha256
            2fa-release.zip
          retention-days: 90

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: .

      - name: Verify downloaded files
        run: |
          echo "ðŸ“¦ ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lhR
          echo ""
          echo "âœ… æ£€æŸ¥å…³é”®æ–‡ä»¶ï¼š"
          test -f dist/worker.js && echo "  âœ“ dist/worker.js" || echo "  âœ— dist/worker.js ä¸å­˜åœ¨"
          test -f dist/worker.debug.js && echo "  âœ“ dist/worker.debug.js" || echo "  âœ— dist/worker.debug.js ä¸å­˜åœ¨"
          test -f dist/worker.metadata.json && echo "  âœ“ dist/worker.metadata.json" || echo "  âœ— dist/worker.metadata.json ä¸å­˜åœ¨"
          test -f dist/DEPLOY.md && echo "  âœ“ dist/DEPLOY.md" || echo "  âœ— dist/DEPLOY.md ä¸å­˜åœ¨"
          test -f 2fa-release.zip && echo "  âœ“ 2fa-release.zip" || echo "  âœ— 2fa-release.zip ä¸å­˜åœ¨"

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_short=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Read metadata
        id: metadata
        run: |
          BUILD_DATE=$(jq -r '.buildDate' dist/worker.metadata.json)
          FILE_SIZE=$(jq -r '.fileSizeKB' dist/worker.metadata.json)
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "file_size=${FILE_SIZE}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## ðŸš€ 2FA Manager ${{ steps.get_version.outputs.version }}

          ### ðŸ“¦ Release ä¿¡æ¯

          - **ç‰ˆæœ¬**: ${{ steps.get_version.outputs.version }}
          - **æž„å»ºæ—¶é—´**: ${{ steps.metadata.outputs.build_date }}
          - **æ–‡ä»¶å¤§å°**: ${{ steps.metadata.outputs.file_size }} KB (åŽ‹ç¼©ç‰ˆ)

          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž

          #### æŽ¨èä¸‹è½½ï¼ˆé€‚åˆå¤§å¤šæ•°ç”¨æˆ·ï¼‰

          **worker.js** - åŽ‹ç¼©ä¼˜åŒ–ç‰ˆæœ¬
          - âœ… æ–‡ä»¶ä½“ç§¯å°
          - âœ… åŠ è½½é€Ÿåº¦å¿«
          - âœ… é€‚åˆç”Ÿäº§çŽ¯å¢ƒ

          #### è°ƒè¯•ç‰ˆæœ¬ï¼ˆé€‚åˆå¼€å‘è€…ï¼‰

          **worker.debug.js** - æœªåŽ‹ç¼©ç‰ˆæœ¬
          - ðŸ” åŒ…å«å®Œæ•´çš„å˜é‡åå’Œæ³¨é‡Š
          - ðŸ› ä¾¿äºŽè°ƒè¯•å’ŒæŽ’æŸ¥é—®é¢˜
          - ðŸ“š ä»£ç å¯è¯»æ€§é«˜

          #### å®Œæ•´åŒ…

          **2fa-release.zip** - åŒ…å«æ‰€æœ‰æ–‡ä»¶
          - worker.js (åŽ‹ç¼©ç‰ˆ)
          - worker.debug.js (è°ƒè¯•ç‰ˆ)
          - worker.metadata.json (å…ƒæ•°æ®)
          - DEPLOY.md (éƒ¨ç½²è¯´æ˜Ž)
          - *.sha256 (æ ¡éªŒå’Œ)

          ### ðŸš€ å¿«é€Ÿéƒ¨ç½²

          #### æ–¹æ³• 1: Cloudflare Dashboard (æœ€ç®€å•)

          1. ä¸‹è½½ `worker.js`
          2. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
          3. è¿›å…¥ "Workers & Pages" â†’ "Create application" â†’ "Create Worker"
          4. å¤åˆ¶ `worker.js` çš„å†…å®¹å¹¶ç²˜è´´
          5. ç‚¹å‡» "Save and Deploy"

          #### æ–¹æ³• 2: Wrangler CLI

          ```bash
          # ä¸‹è½½ worker.js åŽ
          wrangler deploy worker.js
          ```

          ### âš™ï¸ é…ç½®è¦æ±‚

          éƒ¨ç½²åŽéœ€è¦é…ç½®ï¼š

          1. **åˆ›å»º KV Namespace**
             ```bash
             wrangler kv:namespace create SECRETS_KV
             ```

          2. **ç»‘å®š KV** (å˜é‡å: `SECRETS_KV`)

          3. **è®¾ç½®åŠ å¯†å¯†é’¥**ï¼ˆæŽ¨èï¼‰
             ```bash
             # ç”Ÿæˆå¯†é’¥
             node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

             # è®¾ç½®å¯†é’¥
             wrangler secret put ENCRYPTION_KEY
             ```

          è¯¦ç»†è¯´æ˜Žè¯·æŸ¥çœ‹ `DEPLOY.md` æ–‡ä»¶ã€‚

          ### ðŸ”’ å®‰å…¨æç¤º

          - âœ… é¦–æ¬¡è®¿é—®æ—¶ä¼šæç¤ºè®¾ç½®è®¿é—®å¯†ç 
          - âœ… å»ºè®®å¯ç”¨ ENCRYPTION_KEY åŠ å¯†å­˜å‚¨çš„ 2FA å¯†é’¥
          - âœ… å®šæœŸä½¿ç”¨åº”ç”¨å†…çš„å¤‡ä»½åŠŸèƒ½å¯¼å‡ºæ•°æ®

          ### ðŸ“š æ–‡æ¡£

          - [å®Œæ•´æ–‡æ¡£](https://github.com/wuzf/2fa/blob/main/README.md)
          - [éƒ¨ç½²æŒ‡å—](https://github.com/wuzf/2fa/blob/main/docs/DEPLOYMENT.md)
          - [API æ–‡æ¡£](https://github.com/wuzf/2fa/blob/main/docs/API_REFERENCE.md)
          - [PWA åŠŸèƒ½](https://github.com/wuzf/2fa/blob/main/docs/PWA_GUIDE.md)

          ### ðŸ”„ æ›´æ–°æ—¥å¿—

          æŸ¥çœ‹ [CHANGELOG.md](https://github.com/wuzf/2fa/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†çš„ç‰ˆæœ¬æ›´æ–°ä¿¡æ¯ã€‚

          ### ðŸ› é—®é¢˜åé¦ˆ

          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è®¿é—® [Issues](https://github.com/wuzf/2fa/issues) é¡µé¢ã€‚

          ### ðŸ“ æ ¡éªŒå’Œ (SHA256)

          éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š

          ```bash
          # Linux/Mac
          sha256sum -c worker.js.sha256

          # Windows (PowerShell)
          Get-FileHash worker.js -Algorithm SHA256
          ```

          ---

          **Full Changelog**: https://github.com/wuzf/2fa/compare/v0.9.0...${{ steps.get_version.outputs.version }}
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: 2FA Manager ${{ steps.get_version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            dist/worker.js
            dist/worker.debug.js
            dist/worker.metadata.json
            dist/DEPLOY.md
            dist/*.sha256
            2fa-release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release summary
        run: |
          echo "## Release Created Successfully ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date**: ${{ steps.metadata.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: ${{ steps.metadata.outputs.file_size }} KB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [worker.js](https://github.com/wuzf/2fa/releases/download/${{ steps.get_version.outputs.version }}/worker.js)" >> $GITHUB_STEP_SUMMARY
          echo "- [worker.debug.js](https://github.com/wuzf/2fa/releases/download/${{ steps.get_version.outputs.version }}/worker.debug.js)" >> $GITHUB_STEP_SUMMARY
          echo "- [Complete Package](https://github.com/wuzf/2fa/releases/download/${{ steps.get_version.outputs.version }}/2fa-release.zip)" >> $GITHUB_STEP_SUMMARY
