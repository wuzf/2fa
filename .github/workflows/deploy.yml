name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

jobs:
  deploy:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest

    # æ ¹æ®åˆ†æ”¯æˆ–æ‰‹åŠ¨è¾“å…¥ç¡®å®šç¯å¢ƒ
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://2fa.your-domain.workers.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if npm ci 2>/dev/null; then
            echo "âœ… npm ci succeeded"
          else
            echo "âš ï¸ npm ci failed, falling back to npm install"
            npm install
          fi

      - name: Run tests before deploy
        run: npm test

      - name: Generate version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Deploying tagged version: ${VERSION}"
          else
            VERSION=$(node scripts/generate-version.js --git --verbose)
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "Deploying git version: ${VERSION}"
          fi

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # è‡ªåŠ¨è§¦å‘æ—¶éƒ¨ç½²åˆ°é»˜è®¤ç¯å¢ƒï¼ˆproductionï¼‰ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨é€‰æ‹©çš„ç¯å¢ƒ
          command: ${{ github.event.inputs.environment && format('deploy --env {0}', github.event.inputs.environment) || 'deploy' }}
        env:
          SW_VERSION: ${{ steps.version.outputs.version }}

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary ğŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production (default)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment successful!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Deployment Status
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment succeeded"
          else
            echo "âŒ Deployment failed"
          fi
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥åˆ° Slack, Discord, æˆ–å…¶ä»–æœåŠ¡
